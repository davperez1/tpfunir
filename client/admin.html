<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.35/dist/web3.min.js"></script>        
        <script>                            
        const ABI_CROWDFUNDING = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "previousOwner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "OwnershipTransferred",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "renounceOwnership",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "transferOwnership",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        }
      ],
      "name": "setNameCrowdFunding",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getDataCrowdFunding",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "totalToken",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_cantTokenForExchange",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_cantTokenToTheWinner",
          "type": "uint256"
        }
      ],
      "name": "addToken",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "openCrowdFunding",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "closeCrowdFunding",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]
        
        var addressCrowdFunding = "0x86818b1929AB9A81DbB158C346988ce615393fBb";    
        var accounts;
        var cuentaUsuario;

        var instanciaCrowdFundingContract;    

        async function start() {
           window.addEventListener('load', async () => {
                if (window.ethereum) {
                    console.log("Metamask detected!");
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.enable();
                    
                    accounts = await web3.eth.getAccounts();
                    cuentaUsuario = accounts[0];
                    document.getElementById('addressAccountID').innerHTML = cuentaUsuario;
                                
                    instanciaCrowdFundingContract = new web3.eth.Contract(
                      ABI_CROWDFUNDING, addressCrowdFunding);
                    
                      updateDataView();                    
                }
                else{
                    console.log("no se puede conectar a metamask");
                }
           });
        }

      async function updateDataView() {
        var resu = await instanciaCrowdFundingContract.methods.getDataCrowdFunding().call();
        document.getElementById('nombreCrowdFundingID').innerHTML = resu[0];
        document.getElementById('cantTokenForExchangeID').innerHTML = resu[1];
        document.getElementById('cantTokenForToTheWinnerID').innerHTML = resu[2];
        document.getElementById('stateCanFundID').innerHTML = resu[3];
        document.getElementById('cantTotalTokenID').innerHTML = resu[4];
      }
      
      async function guardarNombre() {
        var nombre = document.getElementById('nombreID').value;
        

         await instanciaCrowdFundingContract.methods.setNameCrowdFunding(nombre)
          .send({from: window.cuentaUsuario})
          .once("recepient", (recepient) =>{
	          console.log("success");
          })
          .on("error", () => {
            window.alert("error")
          });
        }

        async function guardarToken() {
          var cantTokenExchangeID = document.getElementById('cantTokenExchangeID').value;
          var cantTokenToTheWinnerID = document.getElementById('cantTokenToTheWinnerID').value;

          await instanciaCrowdFundingContract.methods.addToken(parseInt(cantTokenExchangeID), parseInt(cantTokenToTheWinnerID))
            .send({from: window.cuentaUsuario})
            .once("recepient", (recepient) =>{
	          console.log("success");
          })
          .on("error", () => {
            window.alert("error")
          });

        updateDataView();                    
      }

      async function openCrowdFunding() {
        await instanciaCrowdFundingContract.methods.openCrowdFunding()
          .send({from: window.cuentaUsuario})
          .once("recepient", (recepient) =>{
	          console.log("success");
          })
          .on("error", () => {
            windows.alert("error")
          });
        updateDataView();                    
      }

      async function closeCrowdFunding() {
        await instanciaCrowdFundingContract.methods.closeCrowdFunding()
          .send({from: window.cuentaUsuario})
          .once("recepient", (recepient) =>{
	          console.log("success");
          })
          .on("error", () => {
            windows.alert("error")
          });
        updateDataView();                    
      }


      start(); 

      </script>
      </head>
      <body>

        <table class="tftable" border="1">
            <tr>
              <td colspan="2">
                <span style="font-weight:bold">
                    <div id="resultado">
                        <label>Cuenta de usuario:</label>
                        <label id="addressAccountID">Address Usuario</label>
                    </div>
                </span>                    
              </td>
              <td colspan="2">
                    <span style="font-weight:bold">
                        <div id="resultado">
                            <label>Nombre CrowdFunding:</label>
                            <label id="nombreCrowdFundingID">Nombre CrowdFunding</label>
                        </div>
                    </span>                    
                </td>

                <td colspan="2">
                    <span style="font-weight:bold">
                        <div id="resultado">
                            <label>Cantidad Token Generado</label>
                            <label id="cantTotalTokenID">Cantidad Token Generado</label>
                        </div>
                    </span>                    
                </td>

                <td colspan="2">
                    <span style="font-weight:bold">
                        <div id="resultado">
                            <label>Cantidad Token en Venta:</label>
                            <label id="cantTokenForExchangeID">Cantidad Token en Venta:</label>
                        </div>
                    </span>                    
                </td>
              
                <td colspan="2">
                    <span style="font-weight:bold">
                        <div id="resultado">
                            <label>Cantidad de Token para el Ganador:</label>
                            <label id="cantTokenForToTheWinnerID">Cantidad de Token para el Ganador</label>
                        </div>
                    </span>                    
                </td>                
                <td colspan="2">
                    <span style="font-weight:bold">
                        <div id="resultado">
                            <label>CrowdFunding Abierto:</label>
                            <label id="stateCanFundID">CrowdFunding Abierto</label>
                        </div>
                    </span>                    
                </td>
              </tr>




              <!-- 
              <tr>
                <td colspan="2">
                  <span style="font-weight:bold">
                      <div id="resultado">
                          <label>Cuenta de usuario:</label>
                          <label id="addressAccountID">Address Usuario</label>
                      </div>
                  </span>                    
                </td>
              </tr>
              <tr>
                  <td colspan="2">
                      <span style="font-weight:bold">
                          <div id="resultado">
                              <label>Nombre CrowdFunding:</label>
                              <label id="nombreCrowdFundingID">Nombre CrowdFunding</label>
                          </div>
                      </span>                    
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                      <span style="font-weight:bold">
                          <div id="resultado">
                              <label>Cantidad Token Generado</label>
                              <label id="cantTotalTokenID">Cantidad Token Generado</label>
                          </div>
                      </span>                    
                  </td>
                </tr>

                <tr>
                  <td colspan="2">
                      <span style="font-weight:bold">
                          <div id="resultado">
                              <label>Cantidad Token en Venta:</label>
                              <label id="cantTokenForExchangeID">Cantidad Token en Venta:</label>
                          </div>
                      </span>                    
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                      <span style="font-weight:bold">
                          <div id="resultado">
                              <label>Cantidad de Token para el Ganador:</label>
                              <label id="cantTokenForToTheWinnerID">Cantidad de Token para el Ganador</label>
                          </div>
                      </span>                    
                  </td>
                </tr>
                <tr>
                  <td colspan="2">
                      <span style="font-weight:bold">
                          <div id="resultado">
                              <label>CrowdFunding Abierto:</label>
                              <label id="stateCanFundID">CrowdFunding Abierto</label>
                          </div>
                      </span>                    
                  </td>
                </tr> -->
        </table>

        <br>
        <br>
        <table class="tftable" border="1">
          <tr>
            <td colspan="2">
              <form name="datosForm">
                Nombre: <input id="nombreID" type="text"/><br/> 
                Cantidad Token para Vender: <input id="cantTokenExchangeID" type="number"/><br/>
                Cantidad Token para el Ganador: <input id="cantTokenToTheWinnerID" type="number"/><br/>
              </form>                                    
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <span style="font-weight:bold">Guardar Cambios --></span>
              <input type="button" value="Guardar Nombre" onclick="guardarNombre()">
            </td>              
          </tr>  
          <tr>
            <td colspan="2">
              <span style="font-weight:bold">Guardar Cambios --></span>
              <input type="button" value="Guardar Token Venta/Ganador" onclick="guardarToken()">
            </td>              
          </tr>  
          <tr>
            <td colspan="2">
              <span style="font-weight:bold">Guardar Cambios --></span>
              <input type="button" value="Open CrowdFunding" onclick="openCrowdFunding()">
            </td>              
          </tr>  
          <tr>
            <td colspan="2">
              <span style="font-weight:bold">Guardar Cambios --></span>
              <input type="button" value="Close CrowdFunding" onclick="closeCrowdFunding()">
            </td>              
          </tr>           
        </table>
      
          <div id="consoleRespID"></div>
      </body>
</html>